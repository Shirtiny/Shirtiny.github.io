<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="【长篇】登录认证、权限控制思路整理在我论坛网站中，登录是第一个做的功能，可做的很简单，只是在河水两岸扔了块软绵绵的木板，以供临时的通行。登录认证、权限控制，这两个服务是隐私的入口，需要格外的注意。现在，社区爬取到了很多的用户数据，我觉得是时候对SSO、JWT这方面的知识做个总结了。 我将在这份md中，边写登录认证服务的代码，边记录与总结自己的思考和体会，之后会整理思路，希望能对读者有所帮助。本文所">
<meta name="keywords" content="JWT,登录认证,信息安全">
<meta property="og:type" content="article">
<meta property="og:title" content="JWT+Shiro安全无状态服务">
<meta property="og:url" content="http://Shirtiny.cn/2019/11/13/JWT/index.html">
<meta property="og:site_name" content="☘(๑•̀ㅂ•́)و✧">
<meta property="og:description" content="【长篇】登录认证、权限控制思路整理在我论坛网站中，登录是第一个做的功能，可做的很简单，只是在河水两岸扔了块软绵绵的木板，以供临时的通行。登录认证、权限控制，这两个服务是隐私的入口，需要格外的注意。现在，社区爬取到了很多的用户数据，我觉得是时候对SSO、JWT这方面的知识做个总结了。 我将在这份md中，边写登录认证服务的代码，边记录与总结自己的思考和体会，之后会整理思路，希望能对读者有所帮助。本文所">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-01-01T12:34:40.269Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JWT+Shiro安全无状态服务">
<meta name="twitter:description" content="【长篇】登录认证、权限控制思路整理在我论坛网站中，登录是第一个做的功能，可做的很简单，只是在河水两岸扔了块软绵绵的木板，以供临时的通行。登录认证、权限控制，这两个服务是隐私的入口，需要格外的注意。现在，社区爬取到了很多的用户数据，我觉得是时候对SSO、JWT这方面的知识做个总结了。 我将在这份md中，边写登录认证服务的代码，边记录与总结自己的思考和体会，之后会整理思路，希望能对读者有所帮助。本文所">





  
  
  <link rel="canonical" href="http://Shirtiny.cn/2019/11/13/JWT/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>JWT+Shiro安全无状态服务 | ☘(๑•̀ㅂ•́)و✧</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

 
 


</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    
  <a href="https://github.com/Shirtiny" class="github-corner" aria-label="View source on GitHub">
  <svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
  <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/>
  <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/>
  <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/>
  </svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}
  </style>





    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">☘(๑•̀ㅂ•́)و✧</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-link">

    
    
    
      
    

    

    <a href="/link" rel="section"><i class="menu-item-icon fa fa-fw fa-link"></i> <br>link</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-commonweal">

    
    
    
      
    

    

    <a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>公益 404</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-放映厅">

    
    
    
      
    

    

    <a href="/video/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>放映厅</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://Shirtiny.cn/2019/11/13/JWT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shirtiny">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/shirtiny.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="☘(๑•̀ㅂ•́)و✧">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">JWT+Shiro安全无状态服务

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-11-13 15:19:50" itemprop="dateCreated datePublished" datetime="2019-11-13T15:19:50+08:00">2019-11-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-01-01 20:34:40" itemprop="dateModified" datetime="2020-01-01T20:34:40+08:00">2020-01-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/记录/" itemprop="url" rel="index"><span itemprop="name">记录</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="【长篇】登录认证、权限控制思路整理"><a href="#【长篇】登录认证、权限控制思路整理" class="headerlink" title="【长篇】登录认证、权限控制思路整理"></a>【长篇】登录认证、权限控制思路整理</h1><p>在我论坛网站中，登录是第一个做的功能，可做的很简单，只是在河水两岸扔了块软绵绵的木板，以供临时的通行。登录认证、权限控制，这两个服务是隐私的入口，需要格外的注意。现在，社区爬取到了很多的用户数据，我觉得是时候对SSO、JWT这方面的知识做个总结了。</p>
<p>我将在这份md中，边写登录认证服务的代码，边记录与总结自己的思考和体会，之后会整理思路，希望能对读者有所帮助。本文所有实现，都以java为主，框架使用的是SpringBoot。</p>
<a id="more"></a>

<h2 id="0-需求"><a href="#0-需求" class="headerlink" title="0. 需求"></a>0. 需求</h2><p>登录注册显然是必须的，此外在我的社区网站中，站长、版主、管理员、普通成员一共有这4种角色，大概可以这么看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">站长&gt;管理员&gt;版主&gt;普通成员</span><br></pre></td></tr></table></figure>

<p>普通成员拥有<code>发表帖子</code>、<code>查看帖子</code>、<code>回复评论</code>、<code>私信任意用户</code>等权限</p>
<p>版主则拥有<code>版块管理</code>、<code>版内帖子管理</code>、<code>成员发言权管理</code>等权限</p>
<p>管理员自然拥有<code>版主管理</code>、<code>普通成员管理</code>、<code>版块与帖子管理</code>等权限</p>
<p>站长自然拥有所有权限，包括对权限的修改等。</p>
<p>成员登录，从而进入网站<code>大门</code>，而对成员角色的认证，则是网站的一个<code>小门</code>。</p>
<p><strong>依赖</strong></p>
<p>具体实现上，我打算选用<code>Shiro</code>与<code>JWT</code>来完成。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Shiro--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--JWT--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>选择<code>Shiro</code>是因为其相对轻量，而且<code>shiro</code>这个词我好像经常听到，莫名感觉很亲切。而后者JWT大概是我这份md的主线吧。</p>
<h2 id="1-密码加密存储"><a href="#1-密码加密存储" class="headerlink" title="1. 密码加密存储"></a>1. 密码加密存储</h2><p>显然，无论如何我们都需要把用户存在数据库中，这个有状态服务是无法避免的。</p>
<p>用户表：Users，字段有邮箱、昵称、密码（加密存储）、身份等。</p>
<ul>
<li>密码以密文的形式存储，用户登录时，将邮箱和密码输入，然后网站大门的系统会根据邮箱查询数据库，将用户提交的密码进行加密运算，将运算后得到值去盐与数据库中的密文进行比对，以确认用户是否合法。</li>
</ul>
<h3 id="关于hash加密"><a href="#关于hash加密" class="headerlink" title="关于hash加密"></a>关于hash加密</h3><p>加密需要使用hash散列函数来计算，比如<code>%</code>取余就是最简单的hash运算，常见的hash算法，像MD5、sha256、sha1，MD5已经被能被人为的制造hash碰撞了，所以不推荐使用。</p>
<p>为什么要使用hash加密呢，因为hash是不可逆的，比如<code>x%3=9</code>你无法确定x的值。所以就算得到了数据库中保存的hash值，也难以恢复成原来的密码，而正确的密码取hash后的值，是不变的。</p>
<p>然而，单纯的hash运算后的加密数据，也并不保险，比如彩虹表就能暴力的破解hash。所以又出现了一种更安全的算法<code>加盐hash</code>，它会在hash运算中，带上随机数或字符串，从而增加彩虹表的破解难度</p>
<h3 id="关于浏览器缓存"><a href="#关于浏览器缓存" class="headerlink" title="关于浏览器缓存"></a>关于浏览器缓存</h3><p>说个题外话，web服务器在返回文件时会返回一个eTag作为此文件的唯一标识会放在响应的header里，当浏览器发现再次请求的文件的eTag没有改变时，便不会再拉取文件，这是浏览器的缓存机制，可以节省流量。而eTag是怎么来的呢？我曾经以为是对文件取的hash运算，但后来发现并不是这样。eTag是由文件修改时间<code>time</code>与文件大小<code>size</code>进行按位异或运算，即：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//二进制 按位异或运算</span><br><span class="line">time ^ size =  eTage</span><br><span class="line">//比如：</span><br><span class="line">101000010 ^ 10010110 = 00110100</span><br></pre></td></tr></table></figure>

<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>借助Shiro提供的加密类即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.shirtiny.community.SHcommunity.Utils.Encryption;</span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Component</span>(<span class="string">"shaEncryptor"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShaEncryptor</span> </span>&#123;</span><br><span class="line">    <span class="comment">//使用的加密算法名</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;Shiro_AlgorithmName&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String algorithmName;</span><br><span class="line">    <span class="comment">//盐值</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;Shiro_Salt&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String salt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**加密</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> source 待加密字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加密后的密文*/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">encrypt</span><span class="params">(String source)</span> </span>&#123;</span><br><span class="line">        SimpleHash simpleHash = <span class="keyword">new</span> SimpleHash(algorithmName, source, salt);</span><br><span class="line">        <span class="keyword">return</span> simpleHash.toHex();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对应的配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#shiro加密密码使用的加密算法名 这里是SHA256</span><br><span class="line">Shiro_AlgorithmName=SHA-256</span><br><span class="line">#盐值</span><br><span class="line">Shiro_Salt=salt</span><br></pre></td></tr></table></figure>

<ul>
<li>重写<code>Shiro</code>获取用户认证信息的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.shirtiny.community.SHcommunity.Shiro;</span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"><span class="comment">//Shiro连接数据的桥梁 从数据库获取数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IuserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取认证信息</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        UsernamePasswordToken token = (UsernamePasswordToken) authenticationToken;</span><br><span class="line">        String username = token.getUsername();</span><br><span class="line">        User user = userService.selectOneUserByUserName(username);</span><br><span class="line">        <span class="comment">//当前的realm名 this.getClass().getName() 可写可不写</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(user,user.getPassWord(),<span class="keyword">this</span>.getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>重写<code>Shiro</code>密码校验方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.shirtiny.community.SHcommunity.Shiro;</span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line">    </span><br><span class="line"><span class="comment">//对shiro密码验证规则重写</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShPwdMatcher</span> <span class="keyword">extends</span> <span class="title">SimpleCredentialsMatcher</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShaEncryptor shaEncryptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">doCredentialsMatch</span><span class="params">(AuthenticationToken token, AuthenticationInfo info)</span> </span>&#123;</span><br><span class="line">        UsernamePasswordToken upToken = (UsernamePasswordToken) token;</span><br><span class="line">        <span class="comment">//用户输入的密码</span></span><br><span class="line">        String inputPassWord = <span class="keyword">new</span> String(upToken.getPassword());</span><br><span class="line">        <span class="comment">//对用户输入的密码加密</span></span><br><span class="line">        String encryptedInput = shaEncryptor.encrypt(inputPassWord);</span><br><span class="line">        <span class="comment">//数据库中查出的密码密文</span></span><br><span class="line">        String dbPassword = (String)info.getCredentials();</span><br><span class="line">        <span class="comment">//返回两者是否相同</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.equals(encryptedInput,dbPassword);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-Https"><a href="#2-Https" class="headerlink" title="2. Https"></a>2. Https</h2><p>在上部分中：</p>
<blockquote>
<p>密码以密文的形式存储，用户登录时，将邮箱和密码输入，然后网站大门的系统会根据邮箱查询数据库，将用户提交的密码进行加密运算，将运算后得到值去盐与数据库中的密文进行比对，以确认用户是否合法。</p>
</blockquote>
<p>这样看起来似乎没什么问题，设想一下，如果有一名黑客，在用户发起登录的Post请求时窃听用户邮箱和密码，这该怎么办呢？应该使用https。对于https，我觉得，需要先从非对称加密说起。</p>
<h3 id="关于非对称加密"><a href="#关于非对称加密" class="headerlink" title="关于非对称加密"></a>关于非对称加密</h3><p>最有名的非对称加密算法是<strong>RSA</strong>，非对称加密会生成一个密钥对，包含公钥和私钥。分为两种情况，私钥加密，使用公钥解密；公钥加密，使用私钥解密。</p>
<p>这样看，应该不是很清楚，我会举几个例子说明这两种情形：</p>
<div class="note info">
            <p><strong>情景一</strong></p><ul><li><p>A要发送Message给B</p></li><li><p>A需要先询问B的公钥，B将自己的公钥告诉对方</p></li><li><p>A使用B的公钥加密Message，然后把得到的密文发给B</p></li><li><p>B使用自己的私钥解密Message，获得明文</p></li></ul><p>这样，第三者即使看完了整个通信过程，也无法知道Message的内容。但是，第三者知晓了B的公钥，他也可以使用B的公钥加密消息，向B发送消息，此时B是无法知道写信人是谁的。所以，公钥加密，使用私钥解密，这种情形无法防止伪造的问题。</p>
          </div>

<div class="note info">
            <p><strong>情景二</strong></p><ul><li>依然是A要发送Message给B</li><li>A先把自己公钥发给B</li><li>然后A使用自己的私钥加密了Message，发送给了B</li><li>B根据A的公钥解密Message，便明确的知道Message确实是来自于A</li></ul><p>私钥加密，就像一个人的字迹、签名，能够标识消息的来源。但在这个情形里，Message的内容显然被第三者看的一清二楚。</p>
          </div>

<p>所以我们发现，只使用非对称加密算法，无法满足我们的需要，所以需要引入对称加密算法。</p>
<h3 id="关于对称加密"><a href="#关于对称加密" class="headerlink" title="关于对称加密"></a>关于对称加密</h3><p>对称加密有一个共享密钥PSK<code>Pre Shared Key</code>，原数据使用PSK加密后得到密文，密文使用PSK解密后，便会回到明文。使用对称加密，需要事先发信双方都知道PSK的值。推荐使用<strong>AES对称加密算法</strong>，DES算法已经被攻破。</p>
<div class="note info">
            <p><strong>情景三</strong></p><ul><li>依然是A要发送Message给B</li><li>A需要先询问B的公钥，B将自己的公钥告诉对方</li><li>A把对称加密的密钥PSK放入Message，使用B的公钥加密后，发送给B</li><li>B使用自己的私钥解密Message，得到PSK</li><li>然后，双方便可以使用对称加密算法的PSK进行通信</li></ul><p>这样就可以防止Message内容的泄漏、修改、伪造了，看上去似乎是个很好的解决方式。</p>
          </div>

<p>其实，这三种情形，都有一个更大的问题，A并不清楚对方是不是真正的B，B也同样如此。如何理解呢，这里是有个前提，通信是在网络上进行的，而网络上的身份和现实是不绑定的，就像百度搜索xx官网一样，没有一个充分的理由便不能确认它的真实性。此时需要一个中间的机构，比如百度认证的xx官网，我信任百度，便会相信这个xx官网是真正的。那这个组成信任链的中间机构是谁呢？</p>
<h3 id="CA机构"><a href="#CA机构" class="headerlink" title="CA机构"></a>CA机构</h3><p>比如<code>Let&#39;s Encrypt</code>、<code>DigiCert</code>、<code>赛门铁克</code>等CA机构，就是中间人。CA机构会颁发数字证书给信任的网站，数字证书是公钥和私钥的密钥对，证书由CA机构的私钥签发。浏览器信任CA机构，便会信任CA机构信任的网站，然后当用户访问受信任的网站时，浏览器便会提醒该站是安全可信的。</p>
<p>于是，便可以简单理解为情景四：</p>
<div class="note info">
            <p><strong>情景四</strong></p><ul><li>依然是A要发送Message给B</li><li>A需要先询问B的CA签名公钥，B将CA签名过的公钥告诉对方</li><li>A进行比对，确认是CA签发的，A信任CA，也就信任了B</li><li>A把对称加密的密钥PSK放入Message，使用B的公钥加密后，发送给B</li><li>B使用自己的私钥解密Message，得到PSK</li><li>然后，双方便可以使用对称加密算法的PSK进行通信</li></ul>
          </div>

<h3 id="RSA非对称加密实现"><a href="#RSA非对称加密实现" class="headerlink" title="RSA非对称加密实现"></a>RSA非对称加密实现</h3><p>使用java的security包即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.shirtiny.community.SHcommunity.Utils.Encryption;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.PKCS8EncodedKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.X509EncodedKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RSAKey</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PrivateKey privateKey;</span><br><span class="line">    <span class="keyword">private</span> PublicKey publicKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成密钥</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RSAKey</span><span class="params">()</span> <span class="keyword">throws</span> GeneralSecurityException </span>&#123;</span><br><span class="line">        <span class="comment">//密钥对生成器 生成rsa密钥对生成器</span></span><br><span class="line">        KeyPairGenerator rsaGenerator = KeyPairGenerator.getInstance(<span class="string">"RSA"</span>);</span><br><span class="line">        <span class="comment">//初始化生成器</span></span><br><span class="line">        rsaGenerator.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="comment">//生成密钥对</span></span><br><span class="line">        KeyPair keyPair = rsaGenerator.generateKeyPair();</span><br><span class="line">        <span class="comment">//公钥</span></span><br><span class="line">        <span class="keyword">this</span>.publicKey = keyPair.getPublic();</span><br><span class="line">        <span class="comment">//私钥</span></span><br><span class="line">        <span class="keyword">this</span>.privateKey = keyPair.getPrivate();</span><br><span class="line">        System.out.println(<span class="string">"生成公钥："</span> + Base64.getEncoder().encodeToString(<span class="keyword">this</span>.publicKey.getEncoded()));</span><br><span class="line">        System.out.println(<span class="string">"生成私钥："</span> + Base64.getEncoder().encodeToString(<span class="keyword">this</span>.privateKey.getEncoded()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从已有字符数组中恢复密钥</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RSAKey</span><span class="params">(<span class="keyword">byte</span>[] publicKeyBytes, <span class="keyword">byte</span>[] privateKeyBytes)</span> <span class="keyword">throws</span> GeneralSecurityException </span>&#123;</span><br><span class="line">        <span class="comment">//RSA密钥工厂</span></span><br><span class="line">        KeyFactory rsaFC = KeyFactory.getInstance(<span class="string">"RSA"</span>);</span><br><span class="line">        <span class="comment">//恢复publicKey 需要X509EncodedKeySpec格式</span></span><br><span class="line">        X509EncodedKeySpec publicKeySpec = <span class="keyword">new</span> X509EncodedKeySpec(publicKeyBytes);</span><br><span class="line">        <span class="keyword">this</span>.publicKey = rsaFC.generatePublic(publicKeySpec);</span><br><span class="line">        <span class="comment">//恢复privateKet 需要PKCS8EncodedKeySpec格式</span></span><br><span class="line">        PKCS8EncodedKeySpec privateKeySpec = <span class="keyword">new</span> PKCS8EncodedKeySpec(privateKeyBytes);</span><br><span class="line">        <span class="keyword">this</span>.privateKey = rsaFC.generatePrivate(privateKeySpec);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从已有的Base64字符串中回复密钥</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RSAKey</span><span class="params">(String publicKeyBase64Str, String privateKeyBase64Str)</span> <span class="keyword">throws</span> GeneralSecurityException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(Base64.getDecoder().decode(publicKeyBase64Str), Base64.getDecoder().decode(privateKeyBase64Str));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获得公钥对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PublicKey <span class="title">getPublicKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> publicKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获得私钥对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PrivateKey <span class="title">getPrivateKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> privateKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到公钥字符数组</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getPublicKeyBytes() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.publicKey.getEncoded();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到私钥字符数组</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getPrivateKeyBytes() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.privateKey.getEncoded();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到公钥Base64编码的字符串</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPublicKeyBase64Str</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encodeToString(getPublicKeyBytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到私钥Base64编码的字符串</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPrivateKeyBase64Str</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().encodeToString(getPrivateKeyBytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加密</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] encrypt(<span class="keyword">byte</span>[] str, Key key) <span class="keyword">throws</span> GeneralSecurityException &#123;</span><br><span class="line">        Cipher rsaCipher = Cipher.getInstance(<span class="string">"RSA"</span>);</span><br><span class="line">        <span class="comment">//初始化 加密模式</span></span><br><span class="line">        rsaCipher.init(Cipher.ENCRYPT_MODE, key);</span><br><span class="line">        <span class="keyword">return</span> rsaCipher.doFinal(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解密</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] decrypt(<span class="keyword">byte</span>[] str, Key key) <span class="keyword">throws</span> GeneralSecurityException &#123;</span><br><span class="line">        Cipher rsaCipher = Cipher.getInstance(<span class="string">"RSA"</span>);</span><br><span class="line">        <span class="comment">//初始化 解密模式</span></span><br><span class="line">        rsaCipher.init(Cipher.DECRYPT_MODE, key);</span><br><span class="line">        <span class="keyword">return</span> rsaCipher.doFinal(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//示例</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rsaKeyTest</span><span class="params">()</span> <span class="keyword">throws</span> GeneralSecurityException </span>&#123;</span><br><span class="line">        RSAKey rsaKey = <span class="keyword">new</span> RSAKey();</span><br><span class="line">        String message = <span class="string">"公钥加密的消息"</span>;</span><br><span class="line">        <span class="comment">//公钥加密私钥解</span></span><br><span class="line">        <span class="comment">//公钥加密</span></span><br><span class="line">        <span class="keyword">byte</span>[] encryptedMessage = rsaKey.encrypt(message.getBytes(), rsaKey.getPublicKey());</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(encryptedMessage, StandardCharsets.UTF_8));</span><br><span class="line">        <span class="comment">//私钥解密</span></span><br><span class="line">        <span class="keyword">byte</span>[] decryptedMessage = rsaKey.decrypt(encryptedMessage, rsaKey.getPrivateKey());</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(decryptedMessage, StandardCharsets.UTF_8));</span><br><span class="line">        <span class="comment">//私钥加密公钥解</span></span><br><span class="line">        message = <span class="string">"私钥加密的消息"</span>;</span><br><span class="line">        <span class="comment">//私钥加密</span></span><br><span class="line">        encryptedMessage = rsaKey.encrypt(message.getBytes(), rsaKey.getPrivateKey());</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(encryptedMessage, StandardCharsets.UTF_8));</span><br><span class="line">        <span class="comment">//公钥解密</span></span><br><span class="line">        decryptedMessage = rsaKey.decrypt(encryptedMessage, rsaKey.getPublicKey());</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(decryptedMessage, StandardCharsets.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AES对称加密实现"><a href="#AES对称加密实现" class="headerlink" title="AES对称加密实现"></a>AES对称加密实现</h3><p>与非对称加密类似</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.shirtiny.community.SHcommunity.Utils.Encryption;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.*;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AESKey</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定字符串</span></span><br><span class="line">    <span class="keyword">private</span> String keyStr = <span class="string">"自定义"</span>;</span><br><span class="line">    <span class="comment">//由keyStr生成的AES密钥</span></span><br><span class="line">    <span class="keyword">private</span> SecretKey aesKey;</span><br><span class="line">    <span class="comment">//密钥的Base64编码字符串</span></span><br><span class="line">    <span class="keyword">private</span> String aesKeyBase64Str;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//基于自定字符串 生成新的密钥</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AESKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//key生成器</span></span><br><span class="line">        KeyGenerator aesKeyGenerator = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            aesKeyGenerator = KeyGenerator.getInstance(<span class="string">"AES"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">assert</span> aesKeyGenerator != <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//初始化key生成器 并要求密钥长度为 256 ( keySize: must be equal to 128, 192 or 256 )</span></span><br><span class="line">        aesKeyGenerator.init(<span class="number">256</span>, <span class="keyword">new</span> SecureRandom(<span class="keyword">this</span>.keyStr.getBytes()));</span><br><span class="line">        <span class="comment">//构造aesKey</span></span><br><span class="line">        <span class="keyword">this</span>.aesKey = aesKeyGenerator.generateKey();</span><br><span class="line">        <span class="comment">//aesKey 的base64编码表示</span></span><br><span class="line">        <span class="keyword">this</span>.aesKeyBase64Str = Base64.getEncoder().encodeToString(<span class="keyword">this</span>.aesKey.getEncoded());</span><br><span class="line">        <span class="comment">//打印</span></span><br><span class="line">        System.out.println(<span class="keyword">this</span>.aesKeyBase64Str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从已有密钥base64字符串中恢复密钥</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AESKey</span><span class="params">(String aesKeyBase64Str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.aesKeyBase64Str = aesKeyBase64Str;</span><br><span class="line">        <span class="keyword">byte</span>[] decode = Base64.getDecoder().decode(<span class="keyword">this</span>.aesKeyBase64Str);</span><br><span class="line">        <span class="keyword">this</span>.aesKey = <span class="keyword">new</span> SecretKeySpec(decode, <span class="string">"AES"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回aesKey</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecretKey <span class="title">getAesKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> aesKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回aesKey的Base64字符串</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAesKeyBase64Str</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> aesKeyBase64Str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加密</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] encrypt(String message) <span class="keyword">throws</span> GeneralSecurityException &#123;</span><br><span class="line">        Cipher aesCipher = Cipher.getInstance(<span class="string">"AES"</span>);</span><br><span class="line">        <span class="comment">//初始化 加密模式</span></span><br><span class="line">        aesCipher.init(Cipher.ENCRYPT_MODE, <span class="keyword">this</span>.aesKey);</span><br><span class="line">        <span class="keyword">return</span> aesCipher.doFinal(message.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解密</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">decrypt</span><span class="params">(<span class="keyword">byte</span>[] encrypted)</span> <span class="keyword">throws</span> GeneralSecurityException </span>&#123;</span><br><span class="line">        Cipher aesCipher = Cipher.getInstance(<span class="string">"AES"</span>);</span><br><span class="line">        <span class="comment">//初始化 解密模式</span></span><br><span class="line">        aesCipher.init(Cipher.DECRYPT_MODE, <span class="keyword">this</span>.aesKey);</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = aesCipher.doFinal(encrypted);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(bytes, StandardCharsets.UTF_8);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//示例方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">aesKeyTest</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//基于自定字符串 使用新的aes密钥 来测试加密解密</span></span><br><span class="line">        AESKey aesKey = <span class="keyword">new</span> AESKey();</span><br><span class="line">        String message = <span class="string">"未加密的消息"</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//加密</span></span><br><span class="line">            <span class="keyword">byte</span>[] encrypt = aesKey.encrypt(message);</span><br><span class="line">            System.out.println(<span class="string">"加密后："</span> + <span class="keyword">new</span> String(encrypt, StandardCharsets.UTF_8));</span><br><span class="line">            <span class="comment">//解密</span></span><br><span class="line">            String decrypt = aesKey.decrypt(encrypt);</span><br><span class="line">            System.out.println(<span class="string">"解密后："</span> + decrypt);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (GeneralSecurityException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//从已有字符串中 回复aesKey</span></span><br><span class="line">        String aesBase64Str = Base64.getEncoder().encodeToString(aesKey.getAesKey().getEncoded());</span><br><span class="line">        AESKey aesKey2 = <span class="keyword">new</span> AESKey(aesBase64Str);</span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(aesKey2.getAesKey().getEncoded()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-Token"><a href="#3-Token" class="headerlink" title="3. Token"></a>3. Token</h2><p>所以，使用Https传输，结合加盐Hash加密，便可以完成大门的系统。那么，还有个问题，小门怎么办，登录的大门进入了，权限控制的小门该如何对已登入用户进行认证。</p>
<ul>
<li>如果，在用户通过小门时，再去通过用户邮箱查一遍他的角色信息呢？</li>
</ul>
<p>这是不合适的，此时大门系统和小门系统都是能查到所有用户信息的，这会把重要数据损失的责任分散，如果发现用户信息泄漏了，便不知道该对哪个组件追责。而且，这种设计，会加大数据库的压力。</p>
<h3 id="使用Token（令牌）"><a href="#使用Token（令牌）" class="headerlink" title="使用Token（令牌）"></a>使用Token（令牌）</h3><ul>
<li>由大门系统发放Token，token有有效期，用户携带的令牌由小门系统认证，这样小门系统便被限制了视野范围。</li>
</ul>
<p>使用令牌，无需查询用户信息，只需要能确认Token的合法性。但还有个问题，Token存哪呢？小门怎么知道Token是合法的呢？</p>
<p>先不谈把Token存在数据库或Redis里合不合适，先看这个，<strong>能把Token存Session里吗？</strong></p>
<h3 id="为什么Session不安全"><a href="#为什么Session不安全" class="headerlink" title="为什么Session不安全"></a>为什么Session不安全</h3><p>对于每个用户，服务器都有一块独立内存，怎么标识这些内存所属用户的呢？Http请求之间并没有关联，服务器如果想要标识某个用户，就只能去依赖Cookie，给每个新用户发一个cookie，里面存放一个sessionId，每次用户请求时，就会携带这个cookie，服务器便会根据对应id访问对应内存。</p>
<ul>
<li><p>所以说Session依赖于Cookie，而Cookie会被修改和伪造。完全可以把Cookie中的sessionId修改为另外一个用户的id，便可以伪造成别人，进而获得不该有的权限。</p>
</li>
<li><p>还有个问题，随着用户的增多，服务器内存便可能会不足，而且恶意的人可以不断使用空Cookie请求服务器，这会使服务器开辟出大量的无用内存。</p>
</li>
<li><p>最后一个问题，session是有状态的，由于在内存存储了数据，关机重启或宕机，数据便无法找回，新服务器无法承接旧服务器的工作。</p>
</li>
</ul>
<h3 id="为什么不把Token存在数据库或Redis"><a href="#为什么不把Token存在数据库或Redis" class="headerlink" title="为什么不把Token存在数据库或Redis"></a>为什么不把Token存在数据库或Redis</h3><p>我们再回头来看Token存储在数据库或Redis中会怎样：</p>
<ul>
<li>负担加重</li>
</ul>
<p>这个是毋庸置疑的，如果在数据库多了张Token表，我们不止要去频繁的查询，而且还要去维护Token的有效期，显然存在数据库中是不可取的。看到这，您一定会想，存redis里不就完了，访问量高的话，就做性能优化、集群，甚至用消息队列等。并非如此，问题其实并不是出在性能上，而是不合理，尽量避免有状态服务，方便扩展，减少开销。</p>
<ul>
<li>安全隐患</li>
</ul>
<p>为什么会说有安全隐患呢，因为小门系统通过查询数据库或redis能够拿到任何人的Token，这是不安全的，我们不该让小门系统接触到这些敏感数据，尽量把用户的敏感数据只交给一个系统去负责。</p>
<p>那可以怎么做呢？如何既能避免有状态服务，又能安全的认证token合法性？</p>
<h3 id="数字签名"><a href="#数字签名" class="headerlink" title="数字签名"></a>数字签名</h3><p>什么是数字签名呢，其实这个概念在上面说非对称加密的时候提到过。而在这儿的情景，用户在大门系统登录时，由大门系统确认用户的合法性，然后将用户需要传输的信息，比如昵称、权限等信息使用大门系统的私钥与加密算法进行加密，这部分加密的数据就是数字签名。</p>
<p>在签名完成后，把<strong>数字签名与昵称、权限等明文信息</strong>（通常由Json、Base64编码）一起作为Token，一并交给用户。小门系统对用户进行权限认证时，会使用大门系统的公钥、以及加密时相应对的解密算法对数字签名解密，如果解密后的内容刚好与明文部分吻合，便通过用户合法认证，然后在看明文数据，查看该用户的权限，从而决定是否放行。</p>
<p>有了数字签名系统后，我们只需要维护好大门的私钥，公开大门的公钥，这样，用户如果需要校验令牌是否过期，只需要在本地校验。</p>
<p>这就是完成了简化版的<strong>JWT</strong><code>Json Web Token</code>。</p>
<h2 id="4-JWT"><a href="#4-JWT" class="headerlink" title="4. JWT"></a>4. JWT</h2><p>这是一个我服务器生成的JWT：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eyJ0eXBlIjoiand0Iiwic2lnbkJ5Ijoic2hpcnRpbnkiLCJhbGciOiJSUzI1NiJ9</span><br><span class="line">.eyJqdGkiOiJqd3TllK_kuIBpZCIsInN1YiI6IuS4u-mimCIsImlhdCI6MTU3NDMxNjI5MSwiZXhwIjoxNTc0MzE4MDkxLCLov5nmmK9rZXkiOiLov5nmmK_lgLwifQ</span><br><span class="line">.LVioBqSRdKWq4Doc7JiNAmv3QjxlT94N0wptwoe7SZUPCLbcsGzT19ddUjygvz-zE8f0Nd9GU3wXCdbu2kYpRzlb2x6xwwO6KKYRFPKj6olr_HIKKEumUf4grHHVlWTDuu6FVjJXszMQ_LIleRSjoXqadDCWGiLEV3kjnJ5ybSs</span><br></pre></td></tr></table></figure>

<blockquote>
<p> JWT按<code>.</code>分为3个部分：head、payload、signature</p>
</blockquote>
<p>上面JWT的解析结果为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "header": &#123;</span><br><span class="line">        "type": "jwt",</span><br><span class="line">        "signBy": "shirtiny",</span><br><span class="line">        "alg": "RS256"</span><br><span class="line">    &#125;,</span><br><span class="line">    "body": &#123;</span><br><span class="line">        "jti": "jwt唯一id",</span><br><span class="line">        "sub": "主题",</span><br><span class="line">        "iat": 1574316291,</span><br><span class="line">        "exp": 1574318091,</span><br><span class="line">        "这是key": "这是值"</span><br><span class="line">    &#125;,</span><br><span class="line">    "signature": "LVioBqSRdKWq4Doc7JiNAmv3QjxlT94N0wptwoe7SZUPCLbcsGzT19ddUjygvz-zE8f0Nd9GU3wXCdbu2kYpRzlb2x6xwwO6KKYRFPKj6olr_HIKKEumUf4grHHVlWTDuu6FVjJXszMQ_LIleRSjoXqadDCWGiLEV3kjnJ5ybSs"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>signature</code>便是上文所说的<code>数字签名</code>，也是JWT解析时主要验证的部分。</p>
<p>用户请求时，可以在Http请求头携带<code>Authorization</code>字段，值为JWT字符串，这样服务器就无需存储用户信息，从而达成无状态服务，方便扩展。比如，<code>JavaScript</code>使用<code>axios</code>发送携带<code>Authorization</code>字段的请求：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">axios.post(<span class="string">'/shPri/createInvitation'</span>, &#123;</span><br><span class="line">                        title: title,</span><br><span class="line">                        content: content,</span><br><span class="line">                    &#125;, &#123;</span><br><span class="line">                        headers: &#123;<span class="string">'Authorization'</span>: jwt&#125;</span><br><span class="line">                    &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    					<span class="built_in">console</span>.log(res)</span><br><span class="line">                    &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(error)</span><br><span class="line">                    &#125;)</span><br></pre></td></tr></table></figure>

<p>那么，如果要存的话，JWT存哪呢？我们显然可以不用存在服务器上了，所以我们有两个选择：</p>
<ul>
<li>LocalStorage</li>
</ul>
<p>LocalStorage和服务器没有任何关系，JS可以随意的操作LocalStorage，JWT存在这里，会被轻松拿到，安全性不高。</p>
<ul>
<li>Cookie</li>
</ul>
<p>使用带有HttpOnly的cookie时，通过JavaScript无法访问，防范XSS（跨站脚本，会盗取cookie，应该尽量的过滤用户发布的信息，不让其发布敏感html），发送请求时会自动带上cookie。</p>
<p>JWT一旦被颁发，就无法撤回、一直合法、无法对其再做其他操作，所以一定要为JWT设置适当的过期时间。如果必须要实现对JWT的有效性管理，就避不开有状态服务。</p>
<h3 id="JWT实现"><a href="#JWT实现" class="headerlink" title="JWT实现"></a>JWT实现</h3><p>使用<code>jjwt</code>包即可，这里结合上文的RSA非对称加密，使用RSA算法签名JWT。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.shirtiny.community.SHcommunity.Utils.JWT;</span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="comment">//JWT工具类，暂时只实现了jwt的生成和解析</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtRsaHelper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> PublicKey publicKey;</span><br><span class="line">    <span class="keyword">private</span> PrivateKey privateKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//30分钟后过期 毫秒</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> expirationTime=<span class="number">1800_000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtRsaHelper</span><span class="params">(String publicKeyBase64Str,String privateKeyBase64Str)</span></span>&#123;</span><br><span class="line">        RSAKey rsaKey = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            rsaKey = <span class="keyword">new</span> RSAKey(publicKeyBase64Str,privateKeyBase64Str);</span><br><span class="line">            <span class="keyword">this</span>.privateKey = rsaKey.getPrivateKey();</span><br><span class="line">            <span class="keyword">this</span>.publicKey = rsaKey.getPublicKey();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (GeneralSecurityException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.error(<span class="string">"jwtRsaHelper中的RsaKey密钥对恢复失败"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成jwt 使用私钥签名</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">createJwt</span><span class="params">(Map&lt;String, Object&gt; claims)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//注意把claims第一个设置</span></span><br><span class="line">        JwtBuilder builder = Jwts.builder()</span><br><span class="line">                .setHeaderParam(<span class="string">"type"</span>,<span class="string">"jwt"</span>)</span><br><span class="line">                .setHeaderParam(<span class="string">"signBy"</span>,<span class="string">"shirtiny"</span>)</span><br><span class="line">                .setId(<span class="string">"jwt唯一id"</span>)</span><br><span class="line">                .setSubject(<span class="string">"主题"</span>)</span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> Date())</span><br><span class="line">                .setExpiration(<span class="keyword">new</span> Date(System.currentTimeMillis() + expirationTime))</span><br><span class="line">                .addClaims(claims)</span><br><span class="line">                .signWith(SignatureAlgorithm.RS256, <span class="keyword">this</span>.privateKey);</span><br><span class="line">        <span class="keyword">return</span> builder.compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户令牌</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">createJwt</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; claims = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">//这样user内的信息会作为一个map存入jwt，jwt解析取的时候，需要把user转为map</span></span><br><span class="line">        claims.put(<span class="string">"user"</span>,user);</span><br><span class="line">        claims.put(<span class="string">"userId"</span>,user.getUserId());</span><br><span class="line">        <span class="comment">//注意把claims第一个设置 或使用addClaims</span></span><br><span class="line">        JwtBuilder builder = Jwts.builder()</span><br><span class="line">                .setHeaderParam(<span class="string">"type"</span>,<span class="string">"jwt"</span>)</span><br><span class="line">                .setHeaderParam(<span class="string">"signBy"</span>,<span class="string">"shirtiny"</span>)</span><br><span class="line">                .setId(<span class="string">"Jwt唯一id"</span>)</span><br><span class="line">                .setSubject(user.getUserName())</span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> Date())</span><br><span class="line">                .setExpiration(<span class="keyword">new</span> Date(System.currentTimeMillis() + expirationTime))</span><br><span class="line">                .addClaims(claims)</span><br><span class="line">                .signWith(SignatureAlgorithm.RS256, <span class="keyword">this</span>.privateKey);</span><br><span class="line">        <span class="keyword">return</span> builder.compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析jwt 返回值包含头、负荷、签名</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Jws&lt;Claims&gt; <span class="title">parseJwt</span><span class="params">(String jwt)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Jwts.parser().</span><br><span class="line">                setSigningKey(<span class="keyword">this</span>.publicKey)</span><br><span class="line">                .parseClaimsJws(jwt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获得jwt的body 使用公钥验证签名 如果过期，会抛出ExpiredJwtException</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Claims <span class="title">parseJwtBody</span><span class="params">(String jwt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> parseJwt(jwt)</span><br><span class="line">                .getBody();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获得jwt的header 使用公钥验证签名</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwsHeader <span class="title">parseJwtHeader</span><span class="params">(String jwt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> parseJwt(jwt)</span><br><span class="line">                .getHeader();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获得jwt的签名部分 使用公钥验证签名</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">parseJwtSignature</span><span class="params">(String jwt)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> parseJwt(jwt)</span><br><span class="line">                .getSignature();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtRsaConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">//jwt公钥</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;Jwt_PublicKey_Base64Str&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String publicKeyBase64Str;</span><br><span class="line">    <span class="comment">//jwt私钥</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;Jwt_PrivateKey_Base64Str&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String privateKeyBase64Str;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtRsaHelper <span class="title">generateJwtRsaHelper</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JwtRsaHelper(publicKeyBase64Str,privateKeyBase64Str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>相关配置文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>Jwt公钥 base64编码的字符串 太长，省略一部分</span><br><span class="line">Jwt_PublicKey_Base64Str=MIGfMA0GCSqGSIb3DQEBAQUAA...</span><br><span class="line"><span class="meta">#</span>Jwt私钥 base64编码的字符串 太长，省略一部分</span><br><span class="line">Jwt_PrivateKey_Base64Str=MIICdgIBADANBgkqhkiG...</span><br></pre></td></tr></table></figure>

<ul>
<li>如何使用，比如</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.shirtiny.community.SHcommunity.Service.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtServiceImpl</span> <span class="keyword">implements</span> <span class="title">IjwtService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtRsaHelper jwtRsaHelper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">parseJwtByRequest</span><span class="params">(@NotNull HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        Claims claims=<span class="keyword">null</span>;</span><br><span class="line">        String jwt = request.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line">        <span class="keyword">if</span> (jwt==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            claims = jwtRsaHelper.parseJwtBody(jwt);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> claims;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-Shiro与JWT的整合"><a href="#5-Shiro与JWT的整合" class="headerlink" title="5. Shiro与JWT的整合"></a>5. Shiro与JWT的整合</h2><p>Shiro是基于Session做的认证和权限控制，现在要想修改为依赖JWT来做无状态服务，就不需要使用Session了。</p>
<ul>
<li>在Shiro创建Subject时，不启用session</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.shirtiny.community.SHcommunity.Shiro;</span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="comment">//关闭session</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoSessionWebSubjectFactory</span> <span class="keyword">extends</span> <span class="title">DefaultWebSubjectFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Subject <span class="title">createSubject</span><span class="params">(SubjectContext context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//不使用session</span></span><br><span class="line">        context.setSessionCreationEnabled(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.createSubject(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭Shiro的Session存储策略</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不启用session的subject工厂</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"noSessionWebSubjectFactory"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> NoSessionWebSubjectFactory <span class="title">generateNoSessionWebSubjectFactory</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NoSessionWebSubjectFactory();</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line"><span class="comment">//管理器 实例名为securityManager 注入上面的认证授权器shRealm实例</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"securityManager"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityManager <span class="title">generateSecurityManager</span><span class="params">(@Qualifier(<span class="string">"shRealm"</span>)</span> ShRealm shRealm</span></span><br><span class="line"><span class="function">    ,@<span class="title">Qualifier</span><span class="params">(<span class="string">"noSessionWebSubjectFactory"</span>)</span> NoSessionWebSubjectFactory noSessionWebSubjectFactory) </span>&#123;</span><br><span class="line">        <span class="comment">//管理器，接口的实现使用默认web管理器</span></span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        securityManager.setRealm(shRealm);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 关闭shiro自带的session，详情见文档</span></span><br><span class="line"><span class="comment">         * http://shiro.apache.org/session-management.html#SessionManagement-StatelessApplications%28Sessionless%29</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        DefaultSubjectDAO subjectDAO = <span class="keyword">new</span> DefaultSubjectDAO();</span><br><span class="line">        DefaultSessionStorageEvaluator defaultSessionStorageEvaluator = <span class="keyword">new</span> DefaultSessionStorageEvaluator();</span><br><span class="line">        defaultSessionStorageEvaluator.setSessionStorageEnabled(<span class="keyword">false</span>);</span><br><span class="line">        subjectDAO.setSessionStorageEvaluator(defaultSessionStorageEvaluator);</span><br><span class="line">        securityManager.setSubjectDAO(subjectDAO);</span><br><span class="line">        <span class="comment">//使用自定的无session工厂</span></span><br><span class="line">        securityManager.setSubjectFactory(noSessionWebSubjectFactory);</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>自定Shiro拦截器，根据自己的需求来，下面是一个简单实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.shirtiny.community.SHcommunity.Shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="comment">//自定义的shiro拦截过滤器</span></span><br><span class="line"><span class="comment">//执行流程 preHandle -&gt; isAccessAllowed -&gt; isLoginAttempt -&gt; executeLogin</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShFilter</span> <span class="keyword">extends</span> <span class="title">BasicHttpAuthenticationFilter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IjwtService jwtService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//登录认证 授权</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//如果有登录意向</span></span><br><span class="line">        <span class="keyword">if</span> (isLoginAttempt(request, response)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//执行登录 登录成功后放行</span></span><br><span class="line">               <span class="keyword">return</span> executeLogin(request, response);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (LoginFailedException e) &#123;</span><br><span class="line">                <span class="comment">//登录出现异常</span></span><br><span class="line">                HttpServletResponse httpServletResponse = WebUtils.toHttp(response);</span><br><span class="line">                <span class="comment">//给一个登录失败错误码</span></span><br><span class="line">                httpServletResponse.setStatus(ShErrorCode.Login_Failed_Error.getCode());</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//不放行</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当访问被拒绝时</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//是否要尝试登录</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isLoginAttempt</span><span class="params">(ServletRequest request ,ServletResponse response)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//请求头的Authorization有值时，表示想尝试登录</span></span><br><span class="line">        HttpServletRequest httpRequest = WebUtils.toHttp(request);</span><br><span class="line">        String jwt = httpRequest.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line">        <span class="keyword">return</span> jwt != <span class="keyword">null</span> &amp;&amp; !<span class="string">""</span>.equals(jwt.trim());</span><br><span class="line"><span class="comment">//        return super.isLoginAttempt(request,response);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行登录</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">executeLogin</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> LoginFailedException </span>&#123;</span><br><span class="line">        HttpServletRequest httpRequest = WebUtils.toHttp(request);</span><br><span class="line">        <span class="comment">//解析携带token</span></span><br><span class="line">        Map&lt;String, Object&gt; calims = jwtService.parseJwtByRequest(httpRequest);</span><br><span class="line">        <span class="comment">//暂时处理 能解析出来，就登录成功</span></span><br><span class="line">        <span class="keyword">if</span> (calims!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LoginFailedException(<span class="string">"登录失败，令牌无效"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置拦截器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//过滤器工厂 实例名为shiroFilter 注入上面的管理器securityManager实例</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"shiroFilter"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">generateFilterFactory</span><span class="params">(@Qualifier(<span class="string">"securityManager"</span>)</span> SecurityManager securityManager) </span>&#123;</span><br><span class="line">        ShiroFilterFactoryBean factoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">        <span class="comment">//设置管理器</span></span><br><span class="line">        factoryBean.setSecurityManager(securityManager);</span><br><span class="line">        <span class="comment">//设置登录地址</span></span><br><span class="line">        factoryBean.setLoginUrl(<span class="string">"/loginPage"</span>);</span><br><span class="line">        <span class="comment">//设置登录成功后的跳转地址</span></span><br><span class="line">        factoryBean.setSuccessUrl(<span class="string">"/"</span>);</span><br><span class="line">        <span class="comment">//设置未授权状态跳转的地址</span></span><br><span class="line">        factoryBean.setUnauthorizedUrl(<span class="string">"/403"</span>);</span><br><span class="line">        <span class="comment">// 添加自己的过滤器并且取名为ShFilter</span></span><br><span class="line">        Map&lt;String, Filter&gt; filterMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        filterMap.put(<span class="string">"shFilter"</span>, <span class="keyword">new</span> ShFilter());</span><br><span class="line">        factoryBean.setFilters(filterMap);</span><br><span class="line"></span><br><span class="line">        LinkedHashMap&lt;String, String&gt; filterChainMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">/*DefaultFilter:</span></span><br><span class="line"><span class="comment">        anon：无需认证（登录）可以访问</span></span><br><span class="line"><span class="comment">        authc：必须认证才可以访问</span></span><br><span class="line"><span class="comment">        user：如果使用RememberMe的功能可以直接访问</span></span><br><span class="line"><span class="comment">        perms：该资源必须得到资源权限才可以访问</span></span><br><span class="line"><span class="comment">        role：该资源必须得到角色权限才可以访问</span></span><br><span class="line"><span class="comment">        shFilter：我自定的拦截器</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        filterChainMap.put(<span class="string">"/login"</span>, <span class="string">"anon"</span>);</span><br><span class="line">        filterChainMap.put(<span class="string">"/shPri/**"</span>, <span class="string">"shFilter"</span>);</span><br><span class="line">        <span class="comment">//设置拦截规则</span></span><br><span class="line">        factoryBean.setFilterChainDefinitionMap(filterChainMap);</span><br><span class="line">        <span class="keyword">return</span> factoryBean;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>shiro</code>整体配置文件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.shirtiny.community.SHcommunity.Config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> at.pollux.thymeleaf.shiro.dialect.ShiroDialect;</span><br><span class="line"><span class="keyword">import</span> cn.shirtiny.community.SHcommunity.Shiro.NoSessionWebSubjectFactory;</span><br><span class="line"><span class="keyword">import</span> cn.shirtiny.community.SHcommunity.Shiro.ShFilter;</span><br><span class="line"><span class="keyword">import</span> cn.shirtiny.community.SHcommunity.Shiro.ShPwdMatcher;</span><br><span class="line"><span class="keyword">import</span> cn.shirtiny.community.SHcommunity.Shiro.ShRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.DefaultSessionStorageEvaluator;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.DefaultSubjectDAO;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.LifecycleBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定义的shiro密码比较器 实例名为shPwdMatcher</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"shPwdMatcher"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShPwdMatcher <span class="title">generateShPwdMatcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ShPwdMatcher();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//认证和授权器 实例名为shRealm  注入上面的密码比较器shPwdMatcher实例</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"shRealm"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShRealm <span class="title">generateShRealm</span><span class="params">(@Qualifier(<span class="string">"shPwdMatcher"</span>)</span> ShPwdMatcher shPwdMatcher) </span>&#123;</span><br><span class="line">        ShRealm shRealm = <span class="keyword">new</span> ShRealm();</span><br><span class="line">        <span class="comment">//设置密码比较器</span></span><br><span class="line">        shRealm.setCredentialsMatcher(shPwdMatcher);</span><br><span class="line">        <span class="keyword">return</span> shRealm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//不启用session的自定subject工厂</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"noSessionWebSubjectFactory"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> NoSessionWebSubjectFactory <span class="title">generateNoSessionWebSubjectFactory</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NoSessionWebSubjectFactory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//管理器 实例名为securityManager 注入上面的认证授权器shRealm实例</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"securityManager"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityManager <span class="title">generateSecurityManager</span><span class="params">(@Qualifier(<span class="string">"shRealm"</span>)</span> ShRealm shRealm</span></span><br><span class="line"><span class="function">    ,@<span class="title">Qualifier</span><span class="params">(<span class="string">"noSessionWebSubjectFactory"</span>)</span> NoSessionWebSubjectFactory noSessionWebSubjectFactory) </span>&#123;</span><br><span class="line">        <span class="comment">//管理器，接口的实现使用默认web管理器</span></span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        securityManager.setRealm(shRealm);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 关闭shiro自带的session，详情见文档</span></span><br><span class="line"><span class="comment">         * http://shiro.apache.org/session-management.html#SessionManagement-StatelessApplications%28Sessionless%29</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        DefaultSubjectDAO subjectDAO = <span class="keyword">new</span> DefaultSubjectDAO();</span><br><span class="line">        DefaultSessionStorageEvaluator defaultSessionStorageEvaluator = <span class="keyword">new</span> DefaultSessionStorageEvaluator();</span><br><span class="line">        defaultSessionStorageEvaluator.setSessionStorageEnabled(<span class="keyword">false</span>);</span><br><span class="line">        subjectDAO.setSessionStorageEvaluator(defaultSessionStorageEvaluator);</span><br><span class="line">        securityManager.setSubjectDAO(subjectDAO);</span><br><span class="line">        <span class="comment">//使用自定的无session工厂</span></span><br><span class="line">        securityManager.setSubjectFactory(noSessionWebSubjectFactory);</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//过滤器工厂 实例名为shiroFilter 注入上面的管理器securityManager实例</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"shiroFilter"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">generateFilterFactory</span><span class="params">(@Qualifier(<span class="string">"securityManager"</span>)</span> SecurityManager securityManager) </span>&#123;</span><br><span class="line">        ShiroFilterFactoryBean factoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">        <span class="comment">//设置管理器</span></span><br><span class="line">        factoryBean.setSecurityManager(securityManager);</span><br><span class="line">        <span class="comment">//设置登录地址</span></span><br><span class="line">        factoryBean.setLoginUrl(<span class="string">"/loginPage"</span>);</span><br><span class="line">        <span class="comment">//设置登录成功后的跳转地址</span></span><br><span class="line">        factoryBean.setSuccessUrl(<span class="string">"/"</span>);</span><br><span class="line">        <span class="comment">//设置未授权状态跳转的地址</span></span><br><span class="line">        factoryBean.setUnauthorizedUrl(<span class="string">"/403"</span>);</span><br><span class="line">        <span class="comment">// 添加自己的过滤器并且取名为ShFilter</span></span><br><span class="line">        Map&lt;String, Filter&gt; filterMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        filterMap.put(<span class="string">"shFilter"</span>, <span class="keyword">new</span> ShFilter());</span><br><span class="line">        factoryBean.setFilters(filterMap);</span><br><span class="line"></span><br><span class="line">        LinkedHashMap&lt;String, String&gt; filterChainMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">/*DefaultFilter:</span></span><br><span class="line"><span class="comment">        anon：无需认证（登录）可以访问</span></span><br><span class="line"><span class="comment">        authc：必须认证才可以访问</span></span><br><span class="line"><span class="comment">        user：如果使用RememberMe的功能可以直接访问</span></span><br><span class="line"><span class="comment">        perms：该资源必须得到资源权限才可以访问</span></span><br><span class="line"><span class="comment">        role：该资源必须得到角色权限才可以访问</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        filterChainMap.put(<span class="string">"/login"</span>, <span class="string">"anon"</span>);</span><br><span class="line">        filterChainMap.put(<span class="string">"/shPri/**"</span>, <span class="string">"shFilter"</span>);</span><br><span class="line">        <span class="comment">//设置拦截规则</span></span><br><span class="line">        factoryBean.setFilterChainDefinitionMap(filterChainMap);</span><br><span class="line">        <span class="keyword">return</span> factoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理shiro与spring的关联</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用自定的管理器 配置授权参数源顾问</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title">generateAdvisor</span><span class="params">(@Qualifier(<span class="string">"securityManager"</span>)</span> SecurityManager securityManager) </span>&#123;</span><br><span class="line">        AuthorizationAttributeSourceAdvisor advisor = <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">        advisor.setSecurityManager(securityManager);</span><br><span class="line">        <span class="keyword">return</span> advisor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用代理</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title">useProxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 强制使用cglib，防止重复代理和可能引起代理出错的问题</span></span><br><span class="line">        <span class="comment">// https://zhuanlan.zhihu.com/p/29161098</span></span><br><span class="line">        DefaultAdvisorAutoProxyCreator proxyCreator = <span class="keyword">new</span> DefaultAdvisorAutoProxyCreator();</span><br><span class="line">        proxyCreator.setProxyTargetClass(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> proxyCreator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*    @Bean</span></span><br><span class="line"><span class="comment">      public LifecycleBeanPostProcessor lifecycleBeanPostProcessor() &#123;</span></span><br><span class="line"><span class="comment">          return new LifecycleBeanPostProcessor();</span></span><br><span class="line"><span class="comment">     &#125;</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    //需要在shiro配置文件中增加一个方法，用于thymeleaf和shiro标签配合使用</span></span><br><span class="line"><span class="comment">    @Bean</span></span><br><span class="line"><span class="comment">    public ShiroDialect getShiroDialect() &#123;</span></span><br><span class="line"><span class="comment">        return new ShiroDialect();</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">*/</span>     </span><br><span class="line">    <span class="comment">/*shiro：hasPermission 作用：用于判断用户是否拥有这个权限，有则显示这个div，没有则不显示。</span></span><br><span class="line"><span class="comment">    &lt;div shiro:hasPermission="user:add"&gt;进入用户添加功能：&lt;a href="add"&gt;用户添加&lt;/a&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/div&gt;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/JWT/" rel="tag">#^_^#JWT</a>
          
            <a href="/tags/登录认证/" rel="tag">#^_^#登录认证</a>
          
            <a href="/tags/信息安全/" rel="tag">#^_^#信息安全</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/11/08/关于H2数据库与mysql之间的数据迁移/" rel="next" title="H2数据库数据迁移">
                <i class="fa fa-chevron-left"></i> H2数据库数据迁移
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/11/29/websocket单聊/" rel="prev" title="webSocket单聊+携带Jwt认证">
                webSocket单聊+携带Jwt认证 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/shirtiny.jpg" alt="Shirtiny">
            
              <p class="site-author-name" itemprop="name">Shirtiny</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">57</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">91</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="http://live.bilibili.com/875277" title="直播间 &rarr; http://live.bilibili.com/875277" rel="noopener" target="_blank"><i class="fa fa-fw fa-Bilibili"></i>直播间</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://Shirtiny.cn" title="☘Blog首页 &rarr; https://Shirtiny.cn"><i class="fa fa-fw fa-Shirtiny"></i>☘Blog首页</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#【长篇】登录认证、权限控制思路整理"><span class="nav-text">【长篇】登录认证、权限控制思路整理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0-需求"><span class="nav-text">0. 需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-密码加密存储"><span class="nav-text">1. 密码加密存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#关于hash加密"><span class="nav-text">关于hash加密</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关于浏览器缓存"><span class="nav-text">关于浏览器缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现"><span class="nav-text">实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Https"><span class="nav-text">2. Https</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#关于非对称加密"><span class="nav-text">关于非对称加密</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关于对称加密"><span class="nav-text">关于对称加密</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CA机构"><span class="nav-text">CA机构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RSA非对称加密实现"><span class="nav-text">RSA非对称加密实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AES对称加密实现"><span class="nav-text">AES对称加密实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Token"><span class="nav-text">3. Token</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用Token（令牌）"><span class="nav-text">使用Token（令牌）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么Session不安全"><span class="nav-text">为什么Session不安全</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么不把Token存在数据库或Redis"><span class="nav-text">为什么不把Token存在数据库或Redis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数字签名"><span class="nav-text">数字签名</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-JWT"><span class="nav-text">4. JWT</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JWT实现"><span class="nav-text">JWT实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Shiro与JWT的整合"><span class="nav-text">5. Shiro与JWT的整合</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer"> 
    
    
    
    
    
  <link rel="stylesheet" href="/live2d/css/live2d.css">
  <div id="landlord">
    <div class="message" style="opacity:0"></div>
    <canvas id="live2d" width="280" height="250" class="live2d"></canvas>
     
</div>
<script type="text/javascript" src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript">
    var message_Path = '/live2d/'
    var home_Path = 'https://shirtiny.cn/'
</script>
<script type="text/javascript" src="/live2d/js/live2d.js"></script>
<script type="text/javascript" src="/live2d/js/message.js"></script>
<script type="text/javascript">
    loadlive2d("live2d", "/live2d/model/tia/model.json");
</script>


      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shirtiny</span>

  

  
</div>


  <div class="powered-by">哔哩哔哩@<a href="https://space.bilibili.com/6376560" class="theme-link" rel="noopener" target="_blank">Shirtiny</a> Hexo v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">我的QQ – <a href="http://wpa.qq.com/msgrd?v=3&uin=1849468240&site=qq&menu=yes" class="theme-link" rel="noopener" target="_blank">点此发起聊天</a></div>




        








        
      </div>
    </footer>



    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.2"></script>
  
	



  <script src="/js/motion.js?v=7.1.2"></script>
  
	





  
  


  <script src="/js/affix.js?v=7.1.2"></script>

  <script src="/js/schemes/pisces.js?v=7.1.2"></script>




  
  <script src="/js/scrollspy.js?v=7.1.2"></script>
<script src="/js/post-details.js?v=7.1.2"></script>



  


  <script src="/js/next-boot.js?v=7.1.2"></script>


  

  

  

  


  
    <!-- LOCAL: You can save these files to your site and update links -->

  
  
  <!-- <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"> -->
  <!-- <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script> -->

  <!--  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.css">-->
 <!--  <script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitment.browser.js"></script>-->

  <link rel="stylesheet" href="https://shirtiny.cn/css/myGitment.css">
   <script src="https://shirtiny.cn/js/myGitment.js"></script>
  

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.css">
<!-- END LOCAL -->

<script>
  function renderGitment() {
    var gitment = new Gitment({
      id: '1573629590000',
      owner: 'Shirtiny',
      repo: 'Shirtiny.github.io',
      
      oauth: {
      
      
        client_secret: '76c25434650c2b86dbe4ee767fe2c5caaf543053',
      
        client_id: '0c6e6fcafb8b0265a85a'
      }
    });
    gitment.render('gitment-container');
  }

  

  
    renderGitment();
  
</script>

  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  

  

  

  <!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/clicklove.js"></script>


<!--音乐播放器
<link rel="stylesheet" href="/APlayer/APlayer.min.css">
<div  id="aplayer"></div>
<script type="text/javascript" src="/APlayer/APlayer.min.js"></script>
<script type="text/javascript" src="/APlayer/music.js"></script>
 -->
 
</body>
</html>
